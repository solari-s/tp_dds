<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservar habitación</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; background: #e7eff9; display: flex; justify-content: center; padding: 20px; }
    .window { width: 95%; max-width: 1100px; background: #f4f7fc; border-radius: 14px; box-shadow: 0 0 12px rgba(0,0,0,0.1); padding: 25px; }
    h1 { text-align: center; color: #333; }
    
    .tabs { display: flex; gap: 4px; margin-bottom: 0; }
    .tab { padding: 8px 18px; background: #e0e0e0; border: 1px solid #ccc; border-bottom: none; border-radius: 10px 10px 0 0; cursor: pointer; }
    .tab.active { background: white; border-bottom: 1px solid white; font-weight: bold; }

    .table-box { background: white; border: 1px solid #d3d7de; padding: 10px; height: 400px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #ececec; padding: 10px; position: sticky; top: 0; }
    td { padding: 0; height: 40px; border: 1px solid #ccc; text-align: center; }

    .status-green { background-color: #90ee90; cursor: pointer; }
    .status-gray { background-color: #bfbfbf; cursor: not-allowed; }
    .status-selected { background-color: #4a90e2 !important; color: white !important; }

    .actions { display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px; }
    button { padding: 10px 25px; border-radius: 20px; border: none; cursor: pointer; }
    .btn-reservar { background: #4a90e2; color: white; font-weight: bold; }
</style>
</head>
<body>

<div class="window">
    <h1>Confirmar Reserva</h1>
    <p style="text-align:center" id="infoFechas">Cargando...</p>

    <div class="tabs">
        <div class="tab active" data-tipo="IE">Individual estándar</div>
        <div class="tab" data-tipo="DE">Doble estándar</div>
        <div class="tab" data-tipo="DS">Doble superior</div>
        <div class="tab" data-tipo="SFP">Superior family plan</div>
        <div class="tab" data-tipo="SD">Suite doble</div>
    </div>

    <div class="table-box">
        <table><thead></thead><tbody></tbody></table>
    </div>

    <div class="actions">
        <button onclick="window.location.href='/estado'" style="background:#ccc">Volver</button>
        <button class="btn-reservar" id="btnReservar">Confirmar reserva</button>
    </div>
</div>

<script>
    let datosHabitaciones = [];
    let listaFechas = [];
    let listaFechasISO = [];
    let seleccionActual = null;

    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const desde = params.get("desde");
        const hasta = params.get("hasta");

        if(!desde || !hasta) return alert("Fechas inválidas. Vuelva atrás.");
        document.getElementById("infoFechas").textContent = `Fechas: ${desde} al ${hasta}`;

        const isoDesde = convertirFechaIso(desde);
        const isoHasta = convertirFechaIso(hasta);

        fetch(`/api/habitaciones/estado?desde=${isoDesde}&hasta=${isoHasta}`)
            .then(res => res.json())
            .then(data => {
                datosHabitaciones = data;
                listaFechas = generarRangoFechas(desde, hasta);
                listaFechasISO = generarRangoFechasISO(isoDesde, isoHasta);
                filtrarRenderizar("IE");
            });

        document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => {
            document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
            t.classList.add("active");
            filtrarRenderizar(t.dataset.tipo);
        }));

        document.getElementById("btnReservar").addEventListener("click", realizarReserva);
    });

    function filtrarRenderizar(tipo) {
        const filtradas = datosHabitaciones.filter(h => h.tipo === tipo);
        const thead = document.querySelector("thead");
        const tbody = document.querySelector("tbody");
        thead.innerHTML = ""; tbody.innerHTML = "";

        const trH = document.createElement("tr");
        trH.innerHTML = "<th>Fecha</th>";
        filtradas.sort((a,b)=>a.numero-b.numero).forEach(h => {
            const th = document.createElement("th"); th.textContent = `Hab ${h.numero}`; trH.appendChild(th);
        });
        thead.appendChild(trH);

        listaFechas.forEach((fecha, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${fecha}</td>`;
            filtradas.forEach(h => {
                const td = document.createElement("td");
                const estado = h.estadosPorDia[i];
                
                if(estado === "Disponible") {
                    td.className = "status-green";
                    td.onclick = () => clickCelda(h.numero, i, h.tipo);
                    if(seleccionActual && seleccionActual.numero === h.numero && i >= seleccionActual.inicio && i <= seleccionActual.fin) {
                        td.className = "status-selected";
                    }
                } else {
                    td.className = "status-gray";
                    td.title = estado;
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function clickCelda(numero, index, tipo) {
        if(!seleccionActual || seleccionActual.numero !== numero) {
            seleccionActual = { numero, inicio: index, fin: index, tipo };
        } else {
            if(index < seleccionActual.inicio) seleccionActual = { numero, inicio: index, fin: index, tipo };
            else {
                if(validarRango(numero, seleccionActual.inicio, index)) seleccionActual.fin = index;
                else alert("Rango inválido (días ocupados).");
            }
        }
        filtrarRenderizar(tipo);
    }

    function validarRango(num, ini, fin) {
        const hab = datosHabitaciones.find(h => h.numero === num);
        for(let k=ini; k<=fin; k++) if(hab.estadosPorDia[k] !== "Disponible") return false;
        return true;
    }

    async function realizarReserva() {
        if(!seleccionActual) return alert("Seleccione un rango verde primero.");
        
        const ini = listaFechasISO[seleccionActual.inicio];
        const fin = listaFechasISO[seleccionActual.fin];

        if(!confirm(`Reservar Habitación ${seleccionActual.numero}\nDel ${ini} al ${fin}?`)) return;

        const formData = new URLSearchParams();
        formData.append("tipo", seleccionActual.tipo);
        formData.append("numero", seleccionActual.numero);
        formData.append("fechaInicio", ini);
        formData.append("fechaFin", fin);

        const res = await fetch("/api/reservas/crear", { method: "POST", body: formData });
        alert(await res.text());
        if(res.ok) window.location.href = "/estado";
    }

    // Convierte "dd/MM/yyyy" → "yyyy-MM-dd"
    function convertirFechaIso(s) {
        const [d, m, y] = s.split('/');
        return `${y}-${m}-${d}`;
    }

    // Convierte "yyyy-MM-dd" → objeto Date seguro
    function parseISO(dateStr) {
        const [y, m, d] = dateStr.split('-');
        return new Date(parseInt(y), parseInt(m)-1, parseInt(d));
    }

    // Genera rango ISO bien formado
    function generarRangoFechasISO(desdeISO, hastaISO) {
        let a = parseISO(desdeISO);
        let b = parseISO(hastaISO);
        let r = [];

        while (a <= b) {
            r.push(a.toISOString().split("T")[0]);
            a.setDate(a.getDate() + 1);
        }

        return r;
    }

    // Para mostrar fechas dd/MM/yyyy sin romper
    function generarRangoFechas(desde, hasta) {
        const isoD = convertirFechaIso(desde);
        const isoH = convertirFechaIso(hasta);

        let a = parseISO(isoD);
        let b = parseISO(isoH);
        let r = [];

        while (a <= b) {
            r.push(fmt(a));
            a.setDate(a.getDate() + 1);
        }
        return r;
    }

    function fmt(d) {
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }

</script>
</body>
</html>