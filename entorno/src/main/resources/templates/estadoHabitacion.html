<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado de Habitaciones</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        /* --- ESTILOS GENERALES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            background-color: #e9f0fa;
            max-width: 1100px;
            width: 100%;
            height: auto;
            min-height: 600px;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .window-controls {
            position: absolute;
            top: 15px; right: 15px; display: flex; gap: 10px;
        }
        .win-btn {
            width: 30px; height: 30px; background: #d6eaf8;
            border: 1px solid #a9cce3; border-radius: 4px; color: #4a90e2;
            font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer;
        }

        h1 {
            text-align: center; color: #333; margin-top: 10px; margin-bottom: 40px; font-size: 24px;
        }

        /* --- FORMULARIO SUPERIOR --- */
        .search-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 20px;
        }

        .date-inputs {
            display: flex; gap: 40px; align-items: center;
        }

        .input-group {
            display: flex; align-items: center; gap: 10px;
        }

        label { color: #333; font-weight: 500; font-size: 15px; }

        /* --- ESTILOS "SELECCIONAR" (Idéntico a tu altaHuesped) --- */
        .seleccionar {
            position: relative;
            display: block;
            width: 180px; /* Ajusta el ancho según necesites */
        }

        /* Input modificado para Flatpickr */
        .seleccionar input {
            padding: 8px 12px;
            padding-right: 40px; /* Espacio para el ícono */
            border: 1px solid #a9cce3;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            outline: none;
            background: white;
            width: 100%;
            cursor: pointer; /* Manito al pasar por encima */
        }

        .seleccionar input::placeholder {
            color: #757575; /* Gris del placeholder */
        }

        /* Ícono de calendario (flecha/calendario) */
        .seleccionar .flecha {
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 35px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; /* Click atraviesa al input */
            color: #5C5F62;
            background-color: transparent; 
            border-left: 1px solid transparent; /* Opcional: separador */
        }

        /* --- CLASES DE ERROR --- */
        .input-error {
            border: 2px solid #ff4d4d !important;
            background-color: #fff0f0;
        }

        .btn-primary {
            background-color: #d6eaf8; color: #333; border: 1px solid #a9cce3;
            padding: 10px 30px; border-radius: 20px; font-size: 15px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .btn-primary:hover { background-color: #a9cce3; }

        /* --- RESULTADOS --- */
        .results-box {
            border: 1px solid #a9cce3; background-color: #f0f8ff;
            border-radius: 8px; padding: 20px; display: none; margin-top: 20px;
        }
        .results-box.show { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .results-box h3 { text-align: center; font-size: 16px; margin-bottom: 15px; font-weight: normal; color: #333; }

        /* --- TABS & GRILLA --- */
        .tabs-container { display: flex; gap: 2px; margin-bottom: 0; }
        .tab {
            background-color: #e0e0e0; border: 1px solid #999; border-bottom: none;
            border-radius: 6px 6px 0 0; padding: 8px 15px; font-size: 13px; cursor: pointer; color: #333;
        }
        .tab.active { background-color: white; font-weight: bold; border-bottom: 1px solid white; position: relative; top: 1px; z-index: 5; }

        .grid-wrapper {
            background-color: #e6e6e6; border: 1px solid #999; height: 300px;
            overflow-y: auto; position: relative;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th {
            background-color: #f0f0f0; padding: 12px; text-align: center; font-weight: bold;
            border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 2;
        }
        td:first-child, th:first-child {
            background-color: #f0f0f0; font-weight: bold; width: 120px; border-right: 1px solid #ccc;
        }
        td {
            padding: 0; height: 40px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc;
            text-align: center; vertical-align: middle;
        }
        .status-gray { background-color: #bfbfbf; }
        .status-green { background-color: #90ee90; }

        /* Scrollbar */
        .grid-wrapper::-webkit-scrollbar { width: 18px; }
        .grid-wrapper::-webkit-scrollbar-track { background: #eaf2f8; border-left: 1px solid #a9cce3; }
        .grid-wrapper::-webkit-scrollbar-thumb { background-color: #a9cce3; border-radius: 10px; border: 3px solid #eaf2f8; }

        .bottom-action { display: flex; justify-content: flex-end; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="window-controls">
            <div class="win-btn">_</div>
            <div class="win-btn">X</div>
        </div>

        <h1>Estado de habitaciones</h1>

        <form id="availabilityForm">
            <div class="search-bar">
                <div class="date-inputs">
                    
                    <div class="input-group">
                        <label for="desde">Desde fecha:</label>
                        <div class="seleccionar">
                            <input type="text" id="desde" name="desde" placeholder="Seleccione fecha">
                            <span class="flecha">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14c0 1.11 .89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11 -.89-2 -2-2zm0 16H5V8h14v11z"/>
                                </svg>
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="hasta">Hasta fecha:</label>
                        <div class="seleccionar">
                            <input type="text" id="hasta" name="hasta" placeholder="Seleccione fecha">
                            <span class="flecha">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14c0 1.11 .89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11 -.89-2 -2-2zm0 16H5V8h14v11z"/>
                                </svg>
                            </span>
                        </div>
                    </div>

                </div>
                <button type="submit" class="btn-primary">Siguiente</button>
            </div>
        </form>

        <div id="resultsArea" class="results-box">
            <h3>Habitaciones disponibles</h3>

            <div class="tabs-container">
                <button class="tab active">Individual estándar</button>
                <button class="tab">Doble estándar</button>
                <button class="tab">Doble superior</button>
                <button class="tab">Superior family plan</button>
                <button class="tab">Suite doble</button>
            </div>

            <div class="grid-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th><th>X</th><th>X</th><th>X</th><th>X</th><th>X</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>10/04/25</td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td></tr>
                        <tr><td>11/04/25</td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td></tr>
                        <tr><td>12/04/25</td><td class="status-gray"></td><td class="status-green"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td></tr>
                        <tr><td>13/04/25</td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td></tr>
                        <tr><td>14/04/25</td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td><td class="status-gray"></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="bottom-action">
                <button class="btn-primary">Siguiente</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <script>
        // Variable global para guardar la selección actual { numHabitacion: { inicio: 'indexFila', fin: 'indexFila' } }
        let selecciones = {}; 
        // Variable para guardar los datos traídos del backend y usarlos en la lógica
        let datosHabitaciones = [];
        let listaFechas = [];

        document.addEventListener("DOMContentLoaded", function() {
    
        // Configuración de Flatpickr (ya existente en tu código)
        flatpickr("#desde", { locale: "es", dateFormat: "d/m/Y", allowInput: false, disableMobile: "true" });
        flatpickr("#hasta", { locale: "es", dateFormat: "d/m/Y", allowInput: false, disableMobile: "true" });

        const form = document.getElementById('availabilityForm');
        const resultsArea = document.getElementById('resultsArea');
        const tableHead = document.querySelector("#resultsArea table thead tr");
        const tableBody = document.querySelector("#resultsArea table tbody");

        // --- 1. ENVÍO DEL FORMULARIO Y BUSQUEDA ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
        
            const desdeVal = document.getElementById('desde').value;
            const hastaVal = document.getElementById('hasta').value;

            if (!desdeVal || !hastaVal) {
                alert("Por favor seleccione ambas fechas.");
                return;
            }

            // Llamada al Backend
            fetch(`/api/habitaciones/estado?desde=${desdeVal}&hasta=${hastaVal}`)
                .then(response => {
                    if(!response.ok) throw new Error("Error de red");
                    return response.json();
                })
                .then(data => {
                    datosHabitaciones = data; // Guardamos DTOs
                    listaFechas = generarListaFechas(desdeVal, hastaVal); // Generar strings de fechas para la columna 1
                    renderizarTabla(datosHabitaciones, listaFechas);
                    resultsArea.classList.add('show');
                })
                .catch(err => {
                    console.error(err);
                    alert("Error al consultar disponibilidad.");
                });
        });

        // --- 2. RENDERIZADO DE TABLA ---
        function renderizarTabla(habitaciones, fechas) {
            // A. Renderizar Cabecera (Números de Habitación)
            // Limpiamos todo excepto la primera columna "Fecha"
            tableHead.innerHTML = '<th>Fecha</th>';
        
            // Ordenamos habitaciones por número para que se vean ordenadas
            habitaciones.sort((a, b) => a.numero - b.numero);

            habitaciones.forEach((hab, index) => {
                const th = document.createElement('th');
                th.textContent = `Hab. ${hab.numero}`;
                th.dataset.index = index; // Guardamos índice del array
                th.dataset.numero = hab.numero;
                tableHead.appendChild(th);
            });

            // B. Renderizar Cuerpo (Filas por Fecha)
            tableBody.innerHTML = '';

            // Iteramos por CADA DÍA del rango (N días)
            fechas.forEach((fechaStr, diaIndex) => {
                const tr = document.createElement('tr');
                
                // Celda 1: La fecha
                const tdFecha = document.createElement('td');
                tdFecha.textContent = fechaStr;
                tr.appendChild(tdFecha);

                // Celdas siguientes: Estado de cada habitación para este día
                habitaciones.forEach((hab, habIndex) => {
                    const td = document.createElement('td');
                    // El backend devuelve 'estadosPorDia', una lista de ENUMS
                    const estado = hab.estadosPorDia[diaIndex]; 
                    
                    td.dataset.habIndex = habIndex; // índice en el array datosHabitaciones
                    td.dataset.diaIndex = diaIndex; // índice de la fecha (fila)
                    td.dataset.numero = hab.numero;

                    // Clases CSS según estado
                    if (estado === 'Disponible') {
                        td.classList.add('status-green');
                        td.style.cursor = 'pointer';
                        // Evento de clic para seleccionar
                        td.onclick = () => manejarSeleccion(hab.numero, diaIndex, td);
                    } else {
                        td.classList.add('status-gray');
                        td.title = estado; // Tooltip: "Ocupada", "Reservada", etc.
                        td.style.cursor = 'not-allowed';
                    }

                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        }

        // --- 3. LÓGICA DE SELECCIÓN (Día inicial y final) ---
        function manejarSeleccion(numeroHab, diaIndex, celda) {
            // Inicializar objeto de selección para esta habitación si no existe
            if (!selecciones[numeroHab]) {
                selecciones[numeroHab] = { inicio: null, fin: null };
            }

            const sel = selecciones[numeroHab];

            // Caso A: Primer clic (definir inicio)
            if (sel.inicio === null) {
                sel.inicio = diaIndex;
                celda.style.border = "2px solid blue"; // Feedback visual temporal
                console.log(`Habitación ${numeroHab}: Inicio seleccionado en día ${diaIndex}`);
            } 
            // Caso B: Segundo clic (definir fin y cerrar rango)
            else if (sel.fin === null) {
                // Validar que el fin sea después del inicio
                if (diaIndex < sel.inicio) {
                    alert("La fecha final debe ser posterior a la inicial.");
                    resetSeleccion(numeroHab);
                    return;
                }
                
                // Validar que no haya días ocupados (gris) en el medio
                if (!validarRangoDisponible(numeroHab, sel.inicio, diaIndex)) {
                    alert("No puede seleccionar un rango que incluye días no disponibles.");
                    resetSeleccion(numeroHab);
                    return;
                }

                sel.fin = diaIndex;
                marcarSeleccionVisual(numeroHab, sel.inicio, sel.fin);
                console.log(`Habitación ${numeroHab}: Rango confirmado ${sel.inicio} a ${sel.fin}`);
            } 
            // Caso C: Tercer clic (Reiniciar selección)
            else {
                resetSeleccion(numeroHab);
                // Inicia nueva selección inmediatamente
                selecciones[numeroHab].inicio = diaIndex;
                celda.style.border = "2px solid blue";
            }
        }

        function validarRangoDisponible(numeroHab, inicio, fin) {
            // Buscamos la habitación en los datos originales
            const hab = datosHabitaciones.find(h => h.numero === numeroHab);
            for (let i = inicio; i <= fin; i++) {
                if (hab.estadosPorDia[i] !== 'Disponible') {
                    return false;
                }
            }
            return true;
        }

        function marcarSeleccionVisual(numeroHab, inicio, fin) {
            // Recorrer todas las filas y pintar de azul las celdas de esta habitación en el rango
            const filas = tableBody.querySelectorAll('tr');
            filas.forEach((tr, index) => {
                if (index >= inicio && index <= fin) {
                    // Buscamos la celda que corresponde a esta habitación
                    const celda = tr.querySelector(`td[data-numero='${numeroHab}']`);
                    if (celda) {
                        celda.style.backgroundColor = '#4a90e2'; // Azul de selección
                        celda.style.color = 'white';
                    }
                }
            });
        }

        function resetSeleccion(numeroHab) {
            selecciones[numeroHab] = { inicio: null, fin: null };
            // Restaurar color verde visualmente
            const celdas = tableBody.querySelectorAll(`td[data-numero='${numeroHab}']`);
            celdas.forEach(celda => {
                if (celda.classList.contains('status-green')) {
                    celda.style.backgroundColor = ''; // Volver al color CSS original (verde)
                    celda.style.border = '';
                    celda.style.color = '';
                }
            });
        }

        // --- 4. ACCIÓN BOTÓN SIGUIENTE ---
        const btnSiguienteFinal = document.querySelector(".bottom-action .btn-primary");
        if(btnSiguienteFinal){
            btnSiguienteFinal.addEventListener("click", () => {
                // Recopilar todas las selecciones completas
                const reservasParaProcesar = [];
                
                for (const [num, sel] of Object.entries(selecciones)) {
                    if (sel.inicio !== null && sel.fin !== null) {
                        reservasParaProcesar.push({
                            numeroHabitacion: num,
                            fechaInicio: listaFechas[sel.inicio],
                            fechaFin: listaFechas[sel.fin]
                        });
                    }
                }

                if (reservasParaProcesar.length === 0) {
                    alert("No ha seleccionado ningún rango de fechas completo.");
                    return;
                }

                console.log("Reservando:", reservasParaProcesar);
                alert("Redirigiendo a confirmación de reserva...");
                // Aquí harías un POST al backend o redirigirías guardando en localStorage
                // window.location.href = "/confirmarReserva";
            });
        }

        // --- UTILS ---
        function generarListaFechas(desde, hasta) {
            // Parse dd/mm/yyyy a Date object
            const parseDate = (str) => {
                const [d, m, y] = str.split('/');
                return new Date(y, m - 1, d);
            };
            
            let actual = parseDate(desde);
            const fin = parseDate(hasta);
            const lista = [];

            while (actual <= fin) {
                // Formato dd/mm/yyyy para mostrar
                const dia = actual.getDate().toString().padStart(2, '0');
                const mes = (actual.getMonth() + 1).toString().padStart(2, '0');
                const anio = actual.getFullYear().toString().slice(-2); // 25
                lista.push(`${dia}/${mes}/${anio}`);
                
                actual.setDate(actual.getDate() + 1);
            }
            return lista;
        }
        
        // Filtro por Tabs (Tipo de Habitación)
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault(); // Prevenir submit si es button dentro de form
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tipoSeleccionado = tab.textContent.trim();
                filtrarColumnasPorTipo(tipoSeleccionado);
            });
        });

        function filtrarColumnasPorTipo(tipoTexto) {
            // Mapeo Texto Tab -> Enum TipoHabitacion (ajustar según tus Enums en Java)
            // Valores Enum Java: IE, DE, DS, SFP, SD
            const mapaTipos = {
                "Individual estándar": "IE",
                "Doble estándar": "DE",
                "Doble superior": "DS",
                "Superior family plan": "SFP",
                "Suite doble": "SD"
            };
            const codigoTipo = mapaTipos[tipoTexto];

            // Lógica visual para ocultar/mostrar columnas
            // Iterar cabeceras y celdas y ocultar las que no coincidan con 'codigoTipo'
            // Esto requiere que al renderizar guardemos el 'tipo' en el dataset de la columna
            // (Implementación simplificada: recargar tabla filtrando datosHabitaciones)
            
            const habitacionesFiltradas = datosHabitaciones.filter(h => h.tipo === codigoTipo);
            renderizarTabla(habitacionesFiltradas, listaFechas);
        }
        });
    </script>
</body>
</html>