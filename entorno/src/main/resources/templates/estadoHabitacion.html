<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado de Habitaciones</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            background-color: #e9f0fa;
            max-width: 1100px;
            width: 100%;
            height: auto;
            min-height: 600px;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 {
            text-align: center; color: #333; margin-top: 10px; margin-bottom: 40px; font-size: 24px;
        }

        .search-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 20px;
        }

        .date-inputs {
            display: flex; gap: 40px; align-items: center;
        }

        .input-group {
            display: flex; align-items: center; gap: 10px;
        }
        
        .input-error {
            border: 2px solid #ff4d4d !important;
            background-color: #fff0f0;
        }

        label { color: #333; font-weight: 500; font-size: 15px; }

        .seleccionar {
            position: relative;
            display: block;
            width: 180px; 
        }

        .seleccionar input {
            padding: 8px 12px;
            padding-right: 40px;
            border: 1px solid #a9cce3;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            outline: none;
            background: white;
            width: 100%;
        }

        .seleccionar .flecha {
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 35px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
            color: #5C5F62;
        }

        .btn-primary {
            background-color: #d6eaf8; color: #333; border: 1px solid #a9cce3;
            padding: 10px 30px; border-radius: 20px; font-size: 15px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .btn-primary:hover { background-color: #a9cce3; }

        .results-box {
            border: 1px solid #a9cce3; background-color: #f0f8ff;
            border-radius: 8px; padding: 20px; display: none; margin-top: 20px;
        }
        .results-box.show { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .results-box h3 { text-align: center; font-size: 16px; margin-bottom: 15px; font-weight: normal; color: #333; }

        .tabs-container { display: flex; gap: 2px; margin-bottom: 0; }
        .tab {
            background-color: #e0e0e0; border: 1px solid #999; border-bottom: none;
            border-radius: 6px 6px 0 0; padding: 8px 15px; font-size: 13px; cursor: pointer; color: #333;
        }
        .tab.active { background-color: white; font-weight: bold; border-bottom: 1px solid white; position: relative; top: 1px; z-index: 5; }

        .grid-wrapper {
            background-color: #e6e6e6; border: 1px solid #999; height: 300px;
            overflow-y: auto; position: relative;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th {
            background-color: #f0f0f0; padding: 12px; text-align: center; font-weight: bold;
            border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 2;
        }
        td:first-child, th:first-child {
            background-color: #f0f0f0; font-weight: bold; width: 120px; border-right: 1px solid #ccc;
        }
        td {
            padding: 0; height: 40px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc;
            text-align: center; vertical-align: middle;
        }
        
        .status-gray { background-color: #bfbfbf; color: #555; }
        .status-green { background-color: #90ee90; }

        .grid-wrapper::-webkit-scrollbar { width: 18px; }
        .grid-wrapper::-webkit-scrollbar-track { background: #eaf2f8; border-left: 1px solid #a9cce3; }
        .grid-wrapper::-webkit-scrollbar-thumb { background-color: #a9cce3; border-radius: 10px; border: 3px solid #eaf2f8; }

        .bottom-action { display: flex; justify-content: flex-end; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                <div style="width: 20px; height: 20px; background: #90ee90; border: 1px solid #ccc;"></div> Disponible
            </div>
            <div style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                <div style="width: 20px; height: 20px; background: #bfbfbf; border: 1px solid #ccc;"></div> Ocupada/Reservada
            </div>
        </div>

        <h1>Estado de habitaciones (Visualizador)</h1>

        <form id="availabilityForm">
            <div class="search-bar">
                <div class="date-inputs">
                    <div class="input-group">
                        <label for="desde">Desde fecha:</label>
                        <div class="seleccionar">
                            <input type="text" id="desde" name="desde" placeholder="Seleccione fecha">
                            <span class="flecha">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14c0 1.11 .89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11 -.89-2 -2-2zm0 16H5V8h14v11z"/></svg>
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="hasta">Hasta fecha:</label>
                        <div class="seleccionar">
                            <input type="text" id="hasta" name="hasta" placeholder="Seleccione fecha">
                            <span class="flecha">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14c0 1.11 .89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11 -.89-2 -2-2zm0 16H5V8h14v11z"/></svg>
                            </span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Buscar Disponibilidad</button>
            </div>
        </form>

        <div id="resultsArea" class="results-box">
            <div class="tabs-container">
                <button class="tab active" data-tipo="IE">Individual estándar</button>
                <button class="tab" data-tipo="DE">Doble estándar</button>
                <button class="tab" data-tipo="DS">Doble superior</button>
                <button class="tab" data-tipo="SFP">Superior family plan</button>
                <button class="tab" data-tipo="SD">Suite doble</button>
            </div>

            <div class="grid-wrapper">
                <table>
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="bottom-action">
                <button id="btnSiguiente" class="btn-primary">Siguiente</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
    let datosHabitaciones = [];
    let listaFechas = [];

    document.addEventListener("DOMContentLoaded", function() {

        flatpickr("#desde", { locale: "es", dateFormat: "d/m/Y", allowInput: false, disableMobile: "true" });
        flatpickr("#hasta", { locale: "es", dateFormat: "d/m/Y", allowInput: false, disableMobile: "true" });

        const form = document.getElementById('availabilityForm');
        const resultsArea = document.getElementById('resultsArea');
        const inputDesde = document.getElementById('desde');
        const inputHasta = document.getElementById('hasta');
        const btnSiguiente = document.getElementById('btnSiguiente');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            limpiarErrores();
            
            const desdeVal = inputDesde.value;
            const hastaVal = inputHasta.value;

            if (!desdeVal || !hastaVal) return alert("Seleccione ambas fechas.");

            const fechaInicio = parseDateLocal(desdeVal);
            const fechaFin = parseDateLocal(hastaVal);

            if (fechaInicio > fechaFin) {
                alert("La fecha 'Desde' no puede ser posterior a 'Hasta'.");
                inputDesde.classList.add('input-error');
                return;
            }

            const isoDesde = formatearISO(fechaInicio);
            const isoHasta = formatearISO(fechaFin);

            const tabActiva = document.querySelector('.tab.active');
            const codigoTipo = tabActiva ? tabActiva.dataset.tipo : "IE";

            fetch(`/api/habitaciones/estado?desde=${isoDesde}&hasta=${isoHasta}`)
            .then(response => {
                if (!response.ok) throw new Error("Error en servidor");
                return response.json();
            })
            .then(data => {
                datosHabitaciones = data;
                listaFechas = generarListaFechas(desdeVal, hastaVal);
                
                filtrarColumnasPorTipo(codigoTipo);
                resultsArea.classList.add('show');
            })
            .catch(err => {
                console.error(err);
                alert("Error al cargar disponibilidad.");
            });
        });

        function renderizarTabla(habitacionesFiltradas, fechas) {
            const thead = document.querySelector("table thead");
            const tbody = document.querySelector("table tbody");
            thead.innerHTML = "";
            tbody.innerHTML = "";

            const trHead = document.createElement("tr");
            const thFecha = document.createElement("th");
            thFecha.textContent = "Fecha";
            trHead.appendChild(thFecha);

            habitacionesFiltradas.sort((a,b) => a.numero - b.numero);

            habitacionesFiltradas.forEach(h => {
                const th = document.createElement("th");
                th.textContent = `Hab. ${h.numero}`;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            fechas.forEach((fechaStr, i) => {
                const tr = document.createElement("tr");
                const tdFecha = document.createElement("td");
                tdFecha.textContent = fechaStr;
                tr.appendChild(tdFecha);

                habitacionesFiltradas.forEach(h => {
                    const td = document.createElement("td");
                    const estado = h.estadosPorDia[i];

                    if(estado === 'Disponible') {
                        td.className = 'status-green';
                        td.title = "Disponible";
                    } else {
                        td.className = 'status-gray';
                        td.title = estado;
                        td.innerText = "X";
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // --- MANEJO DE TABS ---
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                filtrarColumnasPorTipo(tab.dataset.tipo);
            });
        });

        function filtrarColumnasPorTipo(codigo) {
            const filtradas = datosHabitaciones.filter(h => h.tipo === codigo);
            renderizarTabla(filtradas, listaFechas);
        }

        // --- BOTÓN SIGUIENTE ---
        btnSiguiente.addEventListener('click', () => {
            const desde = inputDesde.value;
            const hasta = inputHasta.value;
            
            if(!desde || !hasta) {
                alert("Debe realizar una búsqueda primero.");
                return;
            }

            window.location.href = `reservar?desde=${encodeURIComponent(desde)}&hasta=${encodeURIComponent(hasta)}`;
        });

        function parseDateLocal(str) {
            const [d, m, y] = str.split('/');
            return new Date(y, m-1, d);
        }
        function formatearISO(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth()+1).padStart(2,'0');
            const d = String(date.getDate()).padStart(2,'0');
            return `${y}-${m}-${d}`;
        }
        function generarListaFechas(desde, hasta) {
            let actual = parseDateLocal(desde);
            const fin = parseDateLocal(hasta);
            const lista = [];
            while(actual <= fin) {
                const d = String(actual.getDate()).padStart(2,'0');
                const m = String(actual.getMonth()+1).padStart(2,'0');
                const y = String(actual.getFullYear()).slice(-2);
                lista.push(`${d}/${m}/${y}`);
                actual.setDate(actual.getDate()+1);
            }
            return lista;
        }
        function limpiarErrores() {
            inputDesde.classList.remove('input-error');
        }
    });
</script>
</body>
</html>